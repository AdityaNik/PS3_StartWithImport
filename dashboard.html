<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Tata Motors - Advanced Sentiment Analysis Dashboard</title>
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --tata-blue: #0066cc;
                --tata-dark-blue: #004499;
                --tata-light-blue: #e6f3ff;
                --success-green: #10b981;
                --warning-orange: #f59e0b;
                --danger-red: #ef4444;
                --neutral-gray: #6b7280;
                --bg-light: #f8fafc;
                --text-primary: #1e293b;
                --text-secondary: #64748b;
                --border-color: #e2e8f0;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Inter", sans-serif;
                background-color: var(--bg-light);
                color: var(--text-primary);
                line-height: 1.6;
            }

            .header {
                background: linear-gradient(
                    135deg,
                    var(--tata-blue),
                    var(--tata-dark-blue)
                );
                color: white;
                padding: 1.5rem 0;
                box-shadow: var(--shadow-lg);
                position: sticky;
                top: 0;
                z-index: 100;
            }

            .header-content {
                max-width: 1400px;
                margin: 0 auto;
                padding: 0 2rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .header h1 {
                font-size: 1.75rem;
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .header-controls {
                display: flex;
                gap: 1rem;
                align-items: center;
            }

            .theme-toggle,
            .export-btn {
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                cursor: pointer;
                transition: background 0.2s ease;
                font-size: 0.875rem;
            }

            .theme-toggle:hover,
            .export-btn:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 2rem;
            }

            .dashboard-tabs {
                display: flex;
                gap: 0.5rem;
                margin-bottom: 2rem;
                border-bottom: 1px solid var(--border-color);
            }

            .tab-btn {
                padding: 1rem 1.5rem;
                background: none;
                border: none;
                color: var(--text-secondary);
                cursor: pointer;
                font-weight: 500;
                border-bottom: 2px solid transparent;
                transition: all 0.2s ease;
            }

            .tab-btn.active {
                color: var(--tata-blue);
                border-bottom-color: var(--tata-blue);
            }

            .tab-content {
                display: none;
            }

            .model-status {
                margin-top: 0.5rem;
                padding: 0.75rem 1rem;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                color: white;
                font-size: 0.9rem;
                text-align: center;
            }

            .model-status i {
                color: #10b981;
                margin-right: 0.5rem;
            }

            .status-badges {
                margin-top: 0.5rem;
                display: flex;
                gap: 0.5rem;
                justify-content: center;
                flex-wrap: wrap;
            }

            .badge {
                padding: 0.25rem 0.5rem;
                border-radius: 12px;
                font-size: 0.75rem;
                font-weight: 500;
            }

            .badge.active {
                background: #10b981;
                color: white;
            }

            .tab-content.active {
                display: block;
            }

            .main-dashboard {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
                margin-bottom: 2rem;
            }

            .card {
                background: white;
                border-radius: 12px;
                padding: 2rem;
                box-shadow: var(--shadow-md);
                border: 1px solid var(--border-color);
            }

            .card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.5rem;
            }

            .card-title {
                font-size: 1.25rem;
                font-weight: 600;
                color: var(--tata-blue);
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .textarea {
                width: 100%;
                padding: 1rem;
                border: 2px solid var(--border-color);
                border-radius: 8px;
                font-size: 1rem;
                font-family: inherit;
                resize: vertical;
                min-height: 120px;
                transition: border-color 0.2s ease;
                margin-bottom: 1rem;
            }

            .textarea:focus {
                outline: none;
                border-color: var(--tata-blue);
                box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
            }

            .btn {
                background: linear-gradient(
                    135deg,
                    var(--tata-blue),
                    var(--tata-dark-blue)
                );
                color: white;
                padding: 1rem 2rem;
                border: none;
                border-radius: 8px;
                font-size: 1rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                justify-content: center;
            }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            .btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            .btn-secondary {
                background: white;
                color: var(--tata-blue);
                border: 2px solid var(--tata-blue);
            }

            .btn-secondary:hover {
                background: var(--tata-light-blue);
            }

            .loading {
                display: none;
                text-align: center;
                padding: 3rem;
            }

            .spinner {
                border: 4px solid var(--border-color);
                border-top: 4px solid var(--tata-blue);
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                margin: 0 auto 1rem;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            .results {
                display: none;
            }

            .metrics-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
            }

            .metric-card {
                background: var(--bg-light);
                padding: 1.5rem;
                border-radius: 8px;
                border: 1px solid var(--border-color);
            }

            .metric-title {
                font-size: 0.875rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: var(--text-secondary);
                margin-bottom: 0.5rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .metric-value {
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--text-primary);
                margin-bottom: 0.5rem;
            }

            .sentiment-badges {
                display: flex;
                gap: 1rem;
                margin-bottom: 1rem;
            }

            .sentiment-badge {
                padding: 0.75rem 1rem;
                border-radius: 8px;
                font-size: 0.875rem;
                font-weight: 500;
                text-align: center;
                flex: 1;
                border: 1px solid;
            }

            .sentiment-positive {
                background: rgba(16, 185, 129, 0.1);
                color: var(--success-green);
                border-color: rgba(16, 185, 129, 0.2);
            }

            .sentiment-negative {
                background: rgba(239, 68, 68, 0.1);
                color: var(--danger-red);
                border-color: rgba(239, 68, 68, 0.2);
            }

            .sentiment-neutral {
                background: rgba(107, 114, 128, 0.1);
                color: var(--neutral-gray);
                border-color: rgba(107, 114, 128, 0.2);
            }

            .confidence-bar {
                background: var(--border-color);
                height: 6px;
                border-radius: 3px;
                overflow: hidden;
                margin-top: 0.5rem;
            }

            .confidence-fill {
                height: 100%;
                background: var(--tata-blue);
                transition: width 0.8s ease;
            }

            .aspects-container {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .aspect-tag {
                background: var(--tata-light-blue);
                color: var(--tata-dark-blue);
                padding: 0.25rem 0.75rem;
                border-radius: 16px;
                font-size: 0.875rem;
                font-weight: 500;
                border: 1px solid rgba(0, 102, 204, 0.2);
            }

            .category-badge {
                display: inline-block;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-size: 0.875rem;
                font-weight: 500;
                border: 1px solid;
            }

            .category-complaint {
                background: rgba(239, 68, 68, 0.1);
                color: var(--danger-red);
                border-color: rgba(239, 68, 68, 0.2);
            }
            .category-praise {
                background: rgba(16, 185, 129, 0.1);
                color: var(--success-green);
                border-color: rgba(16, 185, 129, 0.2);
            }
            .category-suggestion {
                background: rgba(245, 158, 11, 0.1);
                color: var(--warning-orange);
                border-color: rgba(245, 158, 11, 0.2);
            }
            .category-inquiry {
                background: rgba(0, 102, 204, 0.1);
                color: var(--tata-blue);
                border-color: rgba(0, 102, 204, 0.2);
            }
            .category-comparison {
                background: rgba(107, 114, 128, 0.1);
                color: var(--neutral-gray);
                border-color: rgba(107, 114, 128, 0.2);
            }

            .recommendation-section {
                background: white;
                border-radius: 12px;
                padding: 2rem;
                margin: 2rem 0;
                box-shadow: var(--shadow-md);
                border: 1px solid var(--border-color);
            }

            .priority-badge {
                display: inline-block;
                padding: 0.25rem 0.75rem;
                border-radius: 12px;
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .priority-high {
                background: rgba(239, 68, 68, 0.1);
                color: var(--danger-red);
            }
            .priority-medium {
                background: rgba(245, 158, 11, 0.1);
                color: var(--warning-orange);
            }
            .priority-low {
                background: rgba(16, 185, 129, 0.1);
                color: var(--success-green);
            }

            .recommendation-item {
                margin-bottom: 1.5rem;
            }

            .recommendation-item h4 {
                font-size: 1rem;
                font-weight: 600;
                margin-bottom: 0.5rem;
                color: var(--tata-blue);
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .recommendation-item p {
                color: var(--text-secondary);
                line-height: 1.6;
            }

            .strategies-section {
                background: var(--tata-light-blue);
                border-radius: 12px;
                padding: 2rem;
                margin: 2rem 0;
            }

            .strategy-list {
                list-style: none;
                display: grid;
                gap: 1rem;
            }

            .strategy-item {
                background: white;
                padding: 1.5rem;
                border-radius: 8px;
                border-left: 4px solid var(--tata-blue);
                box-shadow: var(--shadow-sm);
                transition: transform 0.2s ease;
            }

            .strategy-item:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
            }

            .strategy-title {
                font-weight: 600;
                color: var(--tata-blue);
                margin-bottom: 0.5rem;
            }

            .strategy-description {
                color: var(--text-secondary);
                line-height: 1.6;
            }

            .strategy-meta {
                display: flex;
                justify-content: between;
                margin-top: 1rem;
                gap: 1rem;
            }

            .impact-badge,
            .timeline-badge {
                padding: 0.25rem 0.5rem;
                border-radius: 4px;
                font-size: 0.75rem;
                font-weight: 500;
            }

            .impact-high {
                background: rgba(239, 68, 68, 0.1);
                color: var(--danger-red);
            }
            .impact-medium {
                background: rgba(245, 158, 11, 0.1);
                color: var(--warning-orange);
            }
            .impact-low {
                background: rgba(16, 185, 129, 0.1);
                color: var(--success-green);
            }

            .timeline-badge {
                background: rgba(107, 114, 128, 0.1);
                color: var(--neutral-gray);
            }

            .history-section {
                background: white;
                border-radius: 12px;
                padding: 2rem;
                box-shadow: var(--shadow-md);
            }

            .history-item {
                border-bottom: 1px solid var(--border-color);
                padding: 1.5rem 0;
                transition: background 0.2s ease;
            }

            .history-item:last-child {
                border-bottom: none;
            }

            .history-item:hover {
                background: var(--bg-light);
                margin: 0 -1rem;
                padding: 1.5rem 1rem;
                border-radius: 8px;
            }

            .history-header {
                display: flex;
                justify-content: space-between;
                align-items: start;
                margin-bottom: 1rem;
            }

            .history-timestamp {
                font-size: 0.875rem;
                color: var(--text-secondary);
            }

            .history-comment {
                background: var(--bg-light);
                padding: 1rem;
                border-radius: 8px;
                margin-bottom: 1rem;
                font-style: italic;
                color: var(--text-secondary);
            }

            .analytics-overview {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
            }

            .stat-card {
                background: white;
                padding: 1.5rem;
                border-radius: 8px;
                text-align: center;
                box-shadow: var(--shadow-sm);
                border: 1px solid var(--border-color);
            }

            .stat-value {
                font-size: 2rem;
                font-weight: 700;
                color: var(--tata-blue);
                display: block;
            }

            .stat-label {
                font-size: 0.875rem;
                color: var(--text-secondary);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-top: 0.5rem;
            }

            .trend-chart {
                background: white;
                border-radius: 8px;
                padding: 1.5rem;
                margin: 1rem 0;
                box-shadow: var(--shadow-sm);
            }

            .chart-placeholder {
                height: 200px;
                background: var(--bg-light);
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--text-secondary);
            }

            .example-comments {
                margin-top: 1rem;
            }

            .example-comment {
                background: var(--bg-light);
                padding: 1rem;
                border-radius: 8px;
                margin-bottom: 0.5rem;
                cursor: pointer;
                transition: all 0.2s ease;
                border: 1px solid var(--border-color);
            }

            .example-comment:hover {
                background: white;
                box-shadow: var(--shadow-sm);
                transform: translateY(-1px);
            }

            .notification-container {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                pointer-events: none;
            }

            .notification {
                background: var(--success-green);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                margin-bottom: 10px;
                box-shadow: var(--shadow-lg);
                pointer-events: auto;
                cursor: pointer;
                transition: all 0.3s ease;
                max-width: 350px;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .notification.error {
                background: var(--danger-red);
            }

            .notification.warning {
                background: var(--warning-orange);
            }

            .error-state {
                text-align: center;
                padding: 3rem;
                color: var(--text-secondary);
            }

            .empty-state {
                text-align: center;
                padding: 3rem;
                color: var(--text-secondary);
            }

            .empty-state i {
                font-size: 3rem;
                margin-bottom: 1rem;
                opacity: 0.5;
            }

            .location-tag {
                background: rgba(52, 152, 219, 0.1);
                color: #3498db;
                padding: 0.25rem 0.75rem;
                border-radius: 16px;
                font-size: 0.875rem;
                font-weight: 500;
                border: 1px solid rgba(52, 152, 219, 0.2);
                margin-right: 0.5rem;
                margin-bottom: 0.5rem;
                display: inline-block;
            }

            .region-tag {
                background: rgba(155, 89, 182, 0.1);
                color: #9b59b6;
                padding: 0.25rem 0.75rem;
                border-radius: 16px;
                font-size: 0.875rem;
                font-weight: 500;
                border: 1px solid rgba(155, 89, 182, 0.2);
                margin-right: 0.5rem;
                margin-bottom: 0.5rem;
                display: inline-block;
            }

            .city-performance-item {
                background: var(--bg-light);
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 1rem;
                border: 1px solid var(--border-color);
                transition: all 0.2s ease;
            }

            .city-performance-item:hover {
                background: white;
                box-shadow: var(--shadow-sm);
                transform: translateY(-1px);
            }

            .city-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.75rem;
            }

            .city-name {
                font-size: 1.1rem;
                font-weight: 600;
                color: var(--tata-blue);
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .city-stats {
                display: flex;
                gap: 1rem;
                font-size: 0.875rem;
                color: var(--text-secondary);
            }

            .performance-score {
                background: var(--tata-blue);
                color: white;
                padding: 0.25rem 0.5rem;
                border-radius: 12px;
                font-size: 0.75rem;
                font-weight: 600;
            }

            .performance-score.high {
                background: var(--success-green);
            }

            .performance-score.medium {
                background: var(--warning-orange);
            }

            .performance-score.low {
                background: var(--danger-red);
            }

            .regional-card {
                background: white;
                border-radius: 8px;
                padding: 1.5rem;
                margin-bottom: 1rem;
                border-left: 4px solid var(--tata-blue);
                box-shadow: var(--shadow-sm);
            }

            .regional-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }

            .region-name {
                font-size: 1.2rem;
                font-weight: 600;
                color: var(--tata-blue);
            }

            .region-cities {
                color: var(--text-secondary);
                font-size: 0.875rem;
                margin-bottom: 0.5rem;
            }

            .location-insights-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 1rem;
                margin-top: 1rem;
            }

            .insight-card {
                background: white;
                border-radius: 8px;
                padding: 1rem;
                border: 1px solid var(--border-color);
                box-shadow: var(--shadow-sm);
            }

            .insight-title {
                font-weight: 600;
                color: var(--tata-blue);
                margin-bottom: 0.5rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .insight-list {
                list-style: none;
                padding: 0;
            }

            .insight-list li {
                padding: 0.5rem 0;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .insight-list li:last-child {
                border-bottom: none;
            }

            .hotspot-badge {
                background: rgba(231, 76, 60, 0.1);
                color: #e74c3c;
                padding: 0.25rem 0.5rem;
                border-radius: 12px;
                font-size: 0.75rem;
                font-weight: 500;
            }

            .growth-badge {
                background: rgba(46, 204, 113, 0.1);
                color: #2ecc71;
                padding: 0.25rem 0.5rem;
                border-radius: 12px;
                font-size: 0.75rem;
                font-weight: 500;
            }

            @media (max-width: 768px) {
                .container {
                    padding: 1rem;
                }

                .main-dashboard {
                    grid-template-columns: 1fr;
                    gap: 1rem;
                }

                .header-content {
                    flex-direction: column;
                    gap: 1rem;
                    text-align: center;
                }

                .header-controls {
                    justify-content: center;
                }

                .dashboard-tabs {
                    flex-wrap: wrap;
                }

                .sentiment-badges {
                    flex-direction: column;
                }

                .metrics-grid {
                    grid-template-columns: 1fr;
                }

                .location-insights-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <div class="notification-container" id="notification-container"></div>

        <div class="header">
            <div class="header-content">
                <h1>
                    <i class="fas fa-car"></i> Tata Motors Advanced Analytics
                </h1>
                <div class="model-status">
                    <i class="fas fa-brain"></i> Enhanced ML Engine Active
                    <span class="status-badges">
                        <span class="badge active">Intent Classifier</span>
                        <span class="badge active">BERT Analysis</span>
                        <span class="badge active">Smart Caching</span>
                        <span class="badge active">Rule Engine</span>
                    </span>
                </div>
                <div class="header-controls">
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <i class="fas fa-moon"></i> Theme
                    </button>
                    <button class="export-btn" onclick="exportData()">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="export-btn" onclick="openStreamlitDashboard()">
                        <i class="fas fa-chart-line"></i> Advanced Analytics
                    </button>
                </div>
            </div>
        </div>

        <div class="container">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; text-align: center;">
                <h3 style="margin: 0; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <i class="fas fa-rocket"></i>
                    New: Advanced Analytics Dashboard with AI Insights
                </h3>
                <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">
                    Experience ROI analysis, location intelligence, and automated AI recommendations
                    <button onclick="openStreamlitDashboard()" style="background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 0.5rem 1rem; border-radius: 4px; margin-left: 1rem; cursor: pointer;">
                        Launch Advanced Dashboard →
                    </button>
                </p>
            </div>

            <div class="dashboard-tabs">
                <button class="tab-btn active" onclick="showTab('analysis')">
                    <i class="fas fa-brain"></i> Live Analysis
                </button>
                <button class="tab-btn" onclick="showTab('location')">
                    <i class="fas fa-map-marker-alt"></i> Location Analytics
                </button>
                <button class="tab-btn" onclick="showTab('competitive')">
                    <i class="fas fa-trophy"></i> Competitive Intel
                </button>
                <button class="tab-btn" onclick="showTab('xai')">
                    <i class="fas fa-microscope"></i> XAI Explainer
                </button>
                <button class="tab-btn" onclick="showTab('history')">
                    <i class="fas fa-history"></i> History
                </button>
                <button class="tab-btn" onclick="showTab('analytics')">
                    <i class="fas fa-chart-bar"></i> Analytics
                </button>
            </div>

            <!-- Analysis Tab -->
            <div id="analysis-tab" class="tab-content active">
                <div class="main-dashboard">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-comment-dots"></i>
                                Comment Analysis
                            </h2>
                        </div>

                        <textarea
                            id="commentText"
                            class="textarea"
                            placeholder="Enter customer comment here...

Example comments:
• 'The Harman sound system in the Punch is absolutely amazing!'
• 'Service at Delhi dealership was unprofessional'
• 'I wish Safari had ventilated seats in mid variant'"
                        ></textarea>

                        <button
                            id="analyzeBtn"
                            class="btn"
                            onclick="analyzeComment()"
                        >
                            <i class="fas fa-brain"></i>
                            Analyze Comment
                        </button>

                        <div class="example-comments">
                            <h4
                                style="
                                    margin-bottom: 1rem;
                                    color: var(--text-secondary);
                                "
                            >
                                Quick Examples:
                            </h4>
                            <div
                                class="example-comment"
                                onclick="setExample('The Harman sound system in the Punch is absolutely amazing! Best audio experience in this segment.')"
                            >
                                <strong>Positive Feedback:</strong> Harman sound
                                system praise
                            </div>
                            <div
                                class="example-comment"
                                onclick="setExample('The service at Mumbai dealership was terrible. Staff was rude and unprofessional.')"
                            >
                                <strong>Service Complaint:</strong> Mumbai dealership service issues
                            </div>
                            <div
                                class="example-comment"
                                onclick="setExample('I wish the Safari had ventilated seats in the mid-variant. It would be a game-changer for comfort.')"
                            >
                                <strong>Feature Request:</strong> Ventilated
                                seats suggestion
                            </div>
                            <div
                                class="example-comment"
                                onclick="setExample('Confused between Nexon EV and Tiago EV in Delhi market. Which one offers better range and charging speed?')"
                            >
                                <strong>Purchase Inquiry:</strong> Delhi EV model
                                comparison
                            </div>
                            <div
                                class="example-comment"
                                onclick="setExample('The Bangalore dealership provided excellent service during my recent visit. Very professional staff and quick turnaround time.')"
                            >
                                <strong>Location-based Praise:</strong> Bangalore dealership excellence
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-chart-line"></i>
                                Analysis Results
                            </h2>
                            <button
                                id="saveAnalysis"
                                class="btn-secondary"
                                style="display: none"
                                onclick="saveCurrentAnalysis()"
                            >
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>

                        <div id="loading" class="loading">
                            <div class="spinner"></div>
                            <p>Analyzing with BERT and VADER models...</p>
                        </div>

                        <div id="results" class="results">
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-title">
                                        <i class="fas fa-tag"></i> Category
                                    </div>
                                    <div id="categoryResult"></div>
                                </div>

                                <div class="metric-card">
                                    <div class="metric-title">
                                        <i class="fas fa-map-marker-alt"></i> Location
                                    </div>
                                    <div id="locationResult">
                                        <span style="color: var(--text-secondary); font-style: italic;">No location detected</span>
                                    </div>
                                </div>

                                <div class="metric-card">
                                    <div class="metric-title">
                                        <i class="fas fa-cogs"></i> Aspects
                                    </div>
                                    <div
                                        id="aspectsResult"
                                        class="aspects-container"
                                    ></div>
                                </div>
                            </div>

                            <div class="metric-card">
                                <div class="metric-title">
                                    <i class="fas fa-heart"></i> Sentiment
                                    Analysis
                                </div>
                                <div class="sentiment-badges">
                                    <div
                                        class="sentiment-badge"
                                        id="bertSentiment"
                                    >
                                        <strong>BERT (ML)</strong><br />
                                        <span id="bertSentimentText">-</span>
                                        <div class="confidence-bar">
                                            <div
                                                class="confidence-fill"
                                                id="bertConfidence"
                                            ></div>
                                        </div>
                                        <small id="bertConfidenceText"
                                            >0%</small
                                        >
                                    </div>
                                    <div
                                        class="sentiment-badge"
                                        id="vaderSentiment"
                                    >
                                        <strong>VADER (Rule-based)</strong
                                        ><br />
                                        <span id="vaderSentimentText">-</span>
                                        <div id="vaderScores"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div
                    id="recommendationCard"
                    class="recommendation-section"
                    style="display: none"
                >
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-lightbulb"></i>
                            Strategic Recommendation
                        </h2>
                        <span id="priorityBadge" class="priority-badge"></span>
                    </div>

                    <div class="recommendation-item">
                        <h4><i class="fas fa-search"></i> Business Insight</h4>
                        <p id="insightText"></p>
                    </div>

                    <div class="recommendation-item">
                        <h4>
                            <i class="fas fa-chess"></i> Recommended Strategy
                        </h4>
                        <p id="strategyText"></p>
                    </div>

                    <div class="recommendation-item">
                        <h4><i class="fas fa-tasks"></i> Immediate Action</h4>
                        <p id="actionText"></p>
                    </div>

                    <div class="recommendation-item">
                        <h4>
                            <i class="fas fa-handshake"></i> Sentiment Consensus
                        </h4>
                        <p id="consensusText"></p>
                    </div>
                </div>

                <div
                    id="salesStrategies"
                    class="strategies-section"
                    style="display: none"
                >
                    <h2 class="card-title" style="margin-bottom: 1.5rem">
                        <i class="fas fa-rocket"></i>
                        Sales & Improvement Strategies
                    </h2>
                    <ul id="strategiesList" class="strategy-list"></ul>
                </div>
            </div>

            <!-- Location Analytics Tab -->
            <div id="location-tab" class="tab-content">
                <div class="analytics-overview">
                    <div class="stat-card">
                        <span class="stat-value" id="totalCities">0</span>
                        <div class="stat-label">Cities Analyzed</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="bestPerformingCity">-</span>
                        <div class="stat-label">Top City</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="topRegion">-</span>
                        <div class="stat-label">Leading Region</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="avgRegionalScore">0</span>
                        <div class="stat-label">Avg Regional Score</div>
                    </div>
                </div>

                <div class="main-dashboard">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-city"></i> City Performance
                            </h2>
                            <button class="btn-secondary" onclick="refreshLocationData()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                        
                        <div id="cityPerformanceLoading" class="loading" style="display: none; padding: 2rem;">
                            <div class="spinner"></div>
                            <p>Loading city analytics...</p>
                        </div>

                        <div id="cityPerformanceContent">
                            <div class="empty-state">
                                <i class="fas fa-map-marker-alt"></i>
                                <h3>No Location Data</h3>
                                <p>City performance data will appear here</p>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-globe-asia"></i> Regional Overview
                            </h2>
                        </div>
                        
                        <div id="regionalOverviewContent">
                            <div class="empty-state">
                                <i class="fas fa-chart-area"></i>
                                <h3>No Regional Data</h3>
                                <p>Regional analytics will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-search-location"></i> Location Insights
                        </h2>
                    </div>
                    
                    <div class="main-dashboard">
                        <div class="card" style="margin: 0;">
                            <h4>Service Hotspots</h4>
                            <div id="serviceHotspots">
                                <p style="color: var(--text-secondary); font-style: italic;">
                                    Cities with high service-related feedback will appear here
                                </p>
                            </div>
                        </div>
                        
                        <div class="card" style="margin: 0;">
                            <h4>Growth Markets</h4>
                            <div id="growthMarkets">
                                <p style="color: var(--text-secondary); font-style: italic;">
                                    Potential growth markets will appear here
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 1rem;">
                        <h4>Geographic Trends</h4>
                        <div id="geographicTrends">
                            <div class="trend-chart">
                                <div class="chart-placeholder">
                                    Geographic sentiment trends will appear here
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Competitive Intelligence Tab -->
            <div id="competitive-tab" class="tab-content">
                <div class="main-dashboard">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-trophy"></i>
                                Competitive Intelligence Analysis
                            </h2>
                            <button class="btn-secondary" onclick="openStreamlitCompetitive()">
                                <i class="fas fa-external-link-alt"></i> Advanced Analysis
                            </button>
                        </div>

                        <div class="insight-box" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; margin-bottom: 1.5rem;">
                            <h4><i class="fas fa-chart-line"></i> Market Position Analysis</h4>
                            <p>Compare Tata Motors sentiment and performance against key competitors including Mahindra, Hyundai/Kia, and Maruti Suzuki.</p>
                        </div>

                        <!-- Competitive KPIs -->
                        <div class="analytics-overview" style="margin-bottom: 2rem;">
                            <div class="stat-card">
                                <span class="stat-value" id="tataMentions">0</span>
                                <div class="stat-label">Tata Mentions</div>
                            </div>
                            <div class="stat-card">
                                <span class="stat-value" id="competitorMentions">0</span>
                                <div class="stat-label">Competitor Mentions</div>
                            </div>
                            <div class="stat-card">
                                <span class="stat-value" id="sentimentLead">0</span>
                                <div class="stat-label">Sentiment Advantage</div>
                            </div>
                            <div class="stat-card">
                                <span class="stat-value" id="shareOfVoice">0%</span>
                                <div class="stat-label">Share of Voice</div>
                            </div>
                        </div>

                        <div class="card-actions">
                            <button onclick="analyzeCompetitive()" class="btn" id="competitiveBtn">
                                <i class="fas fa-chart-bar"></i>
                                Analyze Market Position
                            </button>
                            
                            <button onclick="refreshCompetitiveData()" class="btn-secondary" style="margin-left: 1rem;">
                                <i class="fas fa-sync"></i>
                                Refresh Data
                            </button>
                        </div>

                        <div id="competitiveLoading" class="loading">
                            <div class="spinner"></div>
                            <p>Analyzing competitive landscape...</p>
                        </div>

                        <div id="competitiveResults" class="results">
                            <h3><i class="fas fa-trophy"></i> Competitive Analysis Results</h3>
                            
                            <div class="insight-grid" style="margin-bottom: 2rem;">
                                <div class="insight-card">
                                    <h4><i class="fas fa-star"></i> Market Performance</h4>
                                    <div id="marketPerformance">
                                        <div class="empty-state">
                                            <i class="fas fa-chart-line"></i>
                                            <p>Performance comparison will appear here</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="insight-card">
                                    <h4><i class="fas fa-exclamation-triangle"></i> Competitive Threats</h4>
                                    <div id="competitiveThreats">
                                        <div class="empty-state">
                                            <i class="fas fa-shield-alt"></i>
                                            <p>Threat analysis will appear here</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header">
                                    <h4><i class="fas fa-balance-scale"></i> Brand Sentiment Comparison</h4>
                                </div>
                                <div id="brandComparison">
                                    <div class="empty-state">
                                        <i class="fas fa-chart-bar"></i>
                                        <p>Brand comparison chart will appear here</p>
                                    </div>
                                </div>
                            </div>

                            <div class="insight-box">
                                <h4><i class="fas fa-lightbulb"></i> Strategic Recommendations</h4>
                                <div id="strategicRecommendations">
                                    <ul>
                                        <li>Monitor competitor mentions and sentiment trends</li>
                                        <li>Identify areas where competitors are gaining positive feedback</li>
                                        <li>Leverage Tata Motors strengths in marketing campaigns</li>
                                        <li>Address competitive weaknesses to gain market advantage</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- XAI Explainer Tab -->
            <div id="xai-tab" class="tab-content">
                <div class="main-dashboard">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-microscope"></i>
                                Explainable AI (XAI) Analysis
                            </h2>
                            <button class="btn-secondary" onclick="openStreamlitXAI()">
                                <i class="fas fa-external-link-alt"></i> Advanced XAI
                            </button>
                        </div>

                        <div class="insight-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; margin-bottom: 1.5rem;">
                            <h4><i class="fas fa-brain"></i> AI Model Transparency</h4>
                            <p>Understand exactly why our AI models make specific predictions. This feature shows which words and phrases most influence the sentiment classification.</p>
                        </div>

                        <textarea
                            id="xaiCommentText"
                            class="textarea"
                            placeholder="Enter a comment to see detailed AI decision analysis...

Example: 'The service at Mumbai dealership was terrible but the car quality is excellent'"
                            rows="4"
                        ></textarea>

                        <div class="card-actions">
                            <button onclick="explainPrediction()" class="btn" id="explainBtn">
                                <i class="fas fa-search-plus"></i>
                                Explain AI Decision
                            </button>
                            
                            <div class="example-buttons" style="margin-top: 1rem;">
                                <button onclick="setXAIExample('Terrible service in Delhi but excellent build quality')" class="btn-secondary" style="margin: 0.25rem;">
                                    Mixed Sentiment Example
                                </button>
                                <button onclick="setXAIExample('Amazing new EV features and great performance')" class="btn-secondary" style="margin: 0.25rem;">
                                    Positive Example
                                </button>
                                <button onclick="setXAIExample('Pricing is too high compared to competitors')" class="btn-secondary" style="margin: 0.25rem;">
                                    Critical Example
                                </button>
                            </div>
                        </div>

                        <div id="xaiLoading" class="loading">
                            <div class="spinner"></div>
                            <p>Analyzing AI decision process...</p>
                        </div>

                        <div id="xaiResults" class="results">
                            <h3><i class="fas fa-chart-line"></i> AI Decision Analysis</h3>
                            
                            <div class="metrics-grid" style="margin-bottom: 2rem;">
                                <div class="metric-card">
                                    <div class="metric-value" id="xaiPrediction">-</div>
                                    <div class="metric-label">Predicted Category</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value" id="xaiConfidence">-</div>
                                    <div class="metric-label">Model Confidence</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">LIME</div>
                                    <div class="metric-label">Explanation Method</div>
                                </div>
                            </div>

                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header">
                                    <h4><i class="fas fa-weight-hanging"></i> Word Influence Analysis</h4>
                                </div>
                                <div id="xaiWordInfluence">
                                    <div class="empty-state">
                                        <i class="fas fa-brain"></i>
                                        <p>Word influence visualization will appear here</p>
                                    </div>
                                </div>
                            </div>

                            <div class="insight-grid">
                                <div class="insight-card positive">
                                    <h4><i class="fas fa-plus-circle"></i> Positive Drivers</h4>
                                    <div id="xaiPositiveWords">-</div>
                                </div>
                                <div class="insight-card negative">
                                    <h4><i class="fas fa-minus-circle"></i> Negative Drivers</h4>
                                    <div id="xaiNegativeWords">-</div>
                                </div>
                            </div>

                            <div class="insight-box">
                                <h4><i class="fas fa-lightbulb"></i> How to Interpret</h4>
                                <ul>
                                    <li><strong>Green bars:</strong> Words that positively influenced the prediction</li>
                                    <li><strong>Red bars:</strong> Words that negatively influenced the prediction</li>
                                    <li><strong>Bar length:</strong> Indicates the strength of influence</li>
                                    <li><strong>Zero line:</strong> Neutral influence point</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history-tab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-history"></i>
                            Analysis History
                        </h2>
                        <button class="btn-secondary" onclick="clearHistory()">
                            <i class="fas fa-trash"></i> Clear History
                        </button>
                    </div>

                    <div id="historyContent">
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <h3>No Analysis History</h3>
                            <p>Your analyzed comments will appear here</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content">
                <div class="analytics-overview">
                    <div class="stat-card">
                        <span class="stat-value" id="totalAnalyses">0</span>
                        <div class="stat-label">Total Analyses</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="avgConfidence">0%</span>
                        <div class="stat-label">Avg Confidence</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="topCategory">-</span>
                        <div class="stat-label">Top Category</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="topAspect">-</span>
                        <div class="stat-label">Top Aspect</div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Sentiment Distribution</h3>
                    <div id="sentimentChart" class="trend-chart">
                        <div class="chart-placeholder">
                            Sentiment trends will appear here after analysis
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Category Breakdown</h3>
                    <div id="categoryChart" class="trend-chart">
                        <div class="chart-placeholder">
                            Category distribution will appear here after
                            analysis
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Global variables
            let currentAnalysis = null;
            let analysisHistory = JSON.parse(
                localStorage.getItem("tata_analysis_history") || "[]",
            );
            let currentTheme = "light";
            let locationAnalytics = null;

            // API Configuration
            const API_BASE_URL = "http://localhost:5001";

            // Tab Management
            function showTab(tabName) {
                document
                    .querySelectorAll(".tab-content")
                    .forEach((tab) => tab.classList.remove("active"));
                document
                    .querySelectorAll(".tab-btn")
                    .forEach((btn) => btn.classList.remove("active"));

                document
                    .getElementById(`${tabName}-tab`)
                    .classList.add("active");
                document
                    .querySelector(`[onclick="showTab('${tabName}')"]`)
                    .classList.add("active");

                if (tabName === "history") {
                    renderHistory();
                } else if (tabName === "analytics") {
                    renderAnalytics();
                } else if (tabName === "location") {
                    loadLocationAnalytics();
                }
            }

            // Location Analytics Functions
            async function loadLocationAnalytics() {
                try {
                    showLocationLoading(true);
                    
                    // Load all location-related data
                    const [analyticsResponse, trendsResponse, regionalResponse] = await Promise.all([
                        fetch(`${API_BASE_URL}/location-analytics`),
                        fetch(`${API_BASE_URL}/city-trends?limit=10`),
                        fetch(`${API_BASE_URL}/regional-performance`)
                    ]);

                    if (!analyticsResponse.ok || !trendsResponse.ok || !regionalResponse.ok) {
                        throw new Error('Failed to fetch location data');
                    }

                    const analyticsData = await analyticsResponse.json();
                    const trendsData = await trendsResponse.json();
                    const regionalData = await regionalResponse.json();

                    locationAnalytics = {
                        analytics: analyticsData.data,
                        trends: trendsData.data,
                        regional: regionalData.data
                    };

                    renderLocationAnalytics();
                    showLocationLoading(false);

                } catch (error) {
                    console.error('Location analytics error:', error);
                    showLocationLoading(false);
                    showLocationError('Failed to load location analytics. Please ensure the backend is running.');
                }
            }

            function showLocationLoading(show) {
                const loading = document.getElementById('cityPerformanceLoading');
                if (loading) {
                    loading.style.display = show ? 'block' : 'none';
                }
            }

            function showLocationError(message) {
                const content = document.getElementById('cityPerformanceContent');
                if (content) {
                    content.innerHTML = `
                        <div class="error-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Error Loading Data</h3>
                            <p>${message}</p>
                        </div>
                    `;
                }
            }

            function renderLocationAnalytics() {
                if (!locationAnalytics) return;

                // Update overview stats
                updateLocationOverviewStats();
                
                // Render city performance
                renderCityPerformance();
                
                // Render regional overview
                renderRegionalOverview();
                
                // Render insights
                renderLocationInsights();
            }

            function updateLocationOverviewStats() {
                const { analytics, trends, regional } = locationAnalytics;
                
                const totalCities = Object.keys(analytics.city_analytics || {}).length;
                document.getElementById('totalCities').textContent = totalCities;

                const bestCity = trends?.top_positive_cities?.[0]?.city || '-';
                document.getElementById('bestPerformingCity').textContent = bestCity;

                const topRegion = Object.keys(regional?.regional_performance || {})[0] || '-';
                document.getElementById('topRegion').textContent = topRegion;

                const avgScore = regional?.regional_rankings?.length > 0 
                    ? (regional.regional_rankings.reduce((sum, r) => sum + r.score, 0) / regional.regional_rankings.length).toFixed(1)
                    : '0';
                document.getElementById('avgRegionalScore').textContent = avgScore;
            }

            function renderCityPerformance() {
                const content = document.getElementById('cityPerformanceContent');
                const cityAnalytics = locationAnalytics.analytics.city_analytics || {};

                if (Object.keys(cityAnalytics).length === 0) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-map-marker-alt"></i>
                            <h3>No City Data Available</h3>
                            <p>City performance data will appear when location-specific comments are analyzed</p>
                        </div>
                    `;
                    return;
                }

                const cityItems = Object.entries(cityAnalytics)
                    .sort(([,a], [,b]) => b.total_comments - a.total_comments)
                    .slice(0, 10)
                    .map(([city, data]) => {
                        const dominantSentiment = data.dominant_sentiment;
                        const positivePercentage = data.sentiment_percentages.positive || 0;
                        const engagementScore = data.engagement_score;
                        
                        let scoreClass = 'medium';
                        if (positivePercentage > 70) scoreClass = 'high';
                        else if (positivePercentage < 40) scoreClass = 'low';

                        return `
                            <div class="city-performance-item">
                                <div class="city-header">
                                    <div class="city-name">
                                        <i class="fas fa-map-marker-alt"></i>
                                        ${city}
                                    </div>
                                    <div class="performance-score ${scoreClass}">
                                        ${positivePercentage.toFixed(1)}%
                                    </div>
                                </div>
                                <div class="city-stats">
                                    <span><i class="fas fa-comments"></i> ${data.total_comments} comments</span>
                                    <span><i class="fas fa-heart"></i> ${dominantSentiment} sentiment</span>
                                    <span><i class="fas fa-chart-line"></i> ${engagementScore} engagement</span>
                                </div>
                                <div class="sentiment-badges" style="margin-top: 0.5rem;">
                                    ${Object.entries(data.sentiment_percentages).map(([sentiment, percentage]) => 
                                        `<div class="sentiment-badge sentiment-${sentiment}" style="flex: none; margin-right: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                            ${sentiment}: ${percentage.toFixed(1)}%
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');

                content.innerHTML = cityItems;
            }

            function renderRegionalOverview() {
                const content = document.getElementById('regionalOverviewContent');
                const regionalData = locationAnalytics.regional.regional_performance || {};

                if (Object.keys(regionalData).length === 0) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-chart-area"></i>
                            <h3>No Regional Data Available</h3>
                            <p>Regional analytics will appear when location data is available</p>
                        </div>
                    `;
                    return;
                }

                const regionalItems = Object.entries(regionalData)
                    .sort(([,a], [,b]) => b.performance_score - a.performance_score)
                    .map(([region, data]) => {
                        return `
                            <div class="regional-card">
                                <div class="regional-header">
                                    <div class="region-name">${region}</div>
                                    <div class="performance-score ${data.performance_score > 70 ? 'high' : data.performance_score > 40 ? 'medium' : 'low'}">
                                        Score: ${data.performance_score}
                                    </div>
                                </div>
                                <div class="region-cities">
                                    <i class="fas fa-city"></i> Cities: ${data.cities.join(', ')}
                                </div>
                                <div class="city-stats">
                                    <span><i class="fas fa-comments"></i> ${data.total_comments} total comments</span>
                                    <span><i class="fas fa-chart-line"></i> ${data.avg_engagement.toFixed(1)} avg engagement</span>
                                    <span><i class="fas fa-building"></i> ${data.cities_covered} cities covered</span>
                                </div>
                                <div class="sentiment-badges" style="margin-top: 0.75rem;">
                                    ${Object.entries(data.sentiment_percentages).map(([sentiment, percentage]) => 
                                        `<div class="sentiment-badge sentiment-${sentiment}" style="flex: none; margin-right: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                            ${sentiment}: ${percentage}%
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');

                content.innerHTML = regionalItems;
            }

            function renderLocationInsights() {
                const trends = locationAnalytics.analytics.geographic_trends || {};
                
                // Service Hotspots
                const serviceHotspotsEl = document.getElementById('serviceHotspots');
                const serviceHotspots = trends.service_hotspots || [];
                
                if (serviceHotspots.length > 0) {
                    serviceHotspotsEl.innerHTML = serviceHotspots.map(hotspot => `
                        <div class="insight-list">
                            <li>
                                <span>
                                    <i class="fas fa-exclamation-triangle"></i>
                                    ${hotspot.city}
                                </span>
                                <span class="hotspot-badge">${hotspot.service_mention_ratio}% service mentions</span>
                            </li>
                        </div>
                    `).join('');
                } else {
                    serviceHotspotsEl.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">No service hotspots identified</p>';
                }

                // Growth Markets
                const growthMarketsEl = document.getElementById('growthMarkets');
                const growthMarkets = trends.growth_markets || [];
                
                if (growthMarkets.length > 0) {
                    growthMarketsEl.innerHTML = growthMarkets.map(market => `
                        <div class="insight-list">
                            <li>
                                <span>
                                    <i class="fas fa-arrow-up"></i>
                                    ${market.city}
                                </span>
                                <span class="growth-badge">${market.positive_sentiment.toFixed(1)}% positive</span>
                            </li>
                        </div>
                    `).join('');
                } else {
                    growthMarketsEl.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">No growth markets identified</p>';
                }

                // Geographic Trends
                const trendsEl = document.getElementById('geographicTrends');
                const highSatisfactionCities = trends.high_satisfaction_cities || [];
                const improvementNeededCities = trends.improvement_needed_cities || [];

                trendsEl.innerHTML = `
                    <div class="location-insights-grid">
                        <div class="insight-card">
                            <div class="insight-title">
                                <i class="fas fa-thumbs-up"></i>
                                High Satisfaction Cities
                            </div>
                            ${highSatisfactionCities.length > 0 
                                ? `<div class="insight-list">${highSatisfactionCities.map(city => `<li><span>${city}</span></li>`).join('')}</div>`
                                : '<p style="color: var(--text-secondary); font-style: italic;">No data available</p>'
                            }
                        </div>
                        <div class="insight-card">
                            <div class="insight-title">
                                <i class="fas fa-exclamation-circle"></i>
                                Improvement Needed
                            </div>
                            ${improvementNeededCities.length > 0 
                                ? `<div class="insight-list">${improvementNeededCities.map(city => `<li><span>${city}</span></li>`).join('')}</div>`
                                : '<p style="color: var(--text-secondary); font-style: italic;">No data available</p>'
                            }
                        </div>
                    </div>
                `;
            }

            async function refreshLocationData() {
                await loadLocationAnalytics();
                showNotification('Location data refreshed!', 'success');
            }

            // Update location display
            function updateLocationDisplay(locationData) {
                const locationResult = document.getElementById('locationResult');
                
                if (!locationData.has_location) {
                    locationResult.innerHTML = '<span style="color: var(--text-secondary); font-style: italic;">No location detected</span>';
                    return;
                }

                let locationHTML = '';
                
                // Display cities
                if (locationData.cities && locationData.cities.length > 0) {
                    locationHTML += locationData.cities.map(city => 
                        `<span class="location-tag"><i class="fas fa-map-marker-alt"></i> ${city}</span>`
                    ).join('');
                }
                
                // Display states
                if (locationData.states && locationData.states.length > 0) {
                    locationHTML += locationData.states.map(state => 
                        `<span class="location-tag"><i class="fas fa-map"></i> ${state}</span>`
                    ).join('');
                }
                
                // Display regions
                if (locationData.regions && locationData.regions.length > 0) {
                    locationHTML += locationData.regions.map(region => 
                        `<span class="region-tag"><i class="fas fa-globe-asia"></i> ${region}</span>`
                    ).join('');
                }

                locationResult.innerHTML = locationHTML || '<span style="color: var(--text-secondary); font-style: italic;">No location detected</span>';
            }

            // Theme Management
            function toggleTheme() {
                currentTheme = currentTheme === "light" ? "dark" : "light";
                document.body.classList.toggle("dark-theme");
                localStorage.setItem("tata_theme", currentTheme);
            }

            // Set example comment
            function setExample(text) {
                document.getElementById("commentText").value = text;
                document.getElementById("commentText").focus();
            }

            // Open Streamlit Dashboard
            function openStreamlitDashboard() {
                // Try to open in new tab/window
                const streamlitUrl = 'http://localhost:8501';
                window.open(streamlitUrl, '_blank');
                showNotification('Opening Advanced Analytics Dashboard...', 'info');
            }

            // Open Streamlit XAI Section
            function openStreamlitXAI() {
                const streamlitUrl = 'http://localhost:8501';
                window.open(streamlitUrl, '_blank');
                showNotification('Opening Advanced XAI Analysis...', 'info');
                // Note: In a real implementation, you might navigate to a specific tab
            }

            // XAI Functions
            function setXAIExample(text) {
                document.getElementById('xaiCommentText').value = text;
                showNotification('Example loaded - click "Explain AI Decision" to analyze', 'info');
            }

            function explainPrediction() {
                const text = document.getElementById('xaiCommentText').value.trim();
                
                if (!text) {
                    showNotification("Please enter a comment to analyze", "warning");
                    return;
                }

                // Show loading state
                document.getElementById('xaiLoading').style.display = 'block';
                document.getElementById('xaiResults').style.display = 'none';
                document.getElementById('explainBtn').disabled = true;

                // Simulate analysis (in real implementation, this would call the backend)
                setTimeout(() => {
                    try {
                        // Simulate AI explanation
                        const explanation = simulateXAIExplanation(text);
                        displayXAIResults(explanation);
                        
                        showNotification("AI decision analysis complete", "success");
                    } catch (error) {
                        console.error('XAI Error:', error);
                        showNotification("Error analyzing AI decision. Please try again.", "error");
                    } finally {
                        document.getElementById('xaiLoading').style.display = 'none';
                        document.getElementById('explainBtn').disabled = false;
                    }
                }, 2000);
            }

            function simulateXAIExplanation(text) {
                const words = text.toLowerCase().split(/\s+/);
                
                // Define word sentiment impacts
                const positiveWords = ['excellent', 'great', 'amazing', 'good', 'love', 'fantastic', 'wonderful', 'best', 'perfect'];
                const negativeWords = ['terrible', 'bad', 'awful', 'horrible', 'hate', 'worst', 'disappointing', 'poor', 'useless'];
                const featureWords = ['service', 'features', 'pricing', 'quality', 'comfort', 'design', 'performance', 'build', 'car'];
                
                const wordInfluences = {};
                const categories = ['Complaint', 'Praise', 'Suggestion', 'Inquiry', 'Comparison'];
                
                let totalScore = 0;
                words.forEach(word => {
                    if (positiveWords.includes(word)) {
                        const influence = Math.random() * 0.4 + 0.4; // 0.4 to 0.8
                        wordInfluences[word] = influence;
                        totalScore += influence;
                    } else if (negativeWords.includes(word)) {
                        const influence = -(Math.random() * 0.4 + 0.4); // -0.4 to -0.8
                        wordInfluences[word] = influence;
                        totalScore += influence;
                    } else if (featureWords.includes(word)) {
                        const influence = (Math.random() - 0.5) * 0.6; // -0.3 to 0.3
                        wordInfluences[word] = influence;
                        totalScore += influence;
                    }
                });

                // Determine predicted category based on overall sentiment
                let predictedCategory;
                if (totalScore > 0.2) {
                    predictedCategory = 'Praise';
                } else if (totalScore < -0.2) {
                    predictedCategory = 'Complaint';
                } else {
                    predictedCategory = Math.random() > 0.5 ? 'Suggestion' : 'Inquiry';
                }

                const confidence = Math.min(0.95, Math.max(0.65, 0.75 + Math.abs(totalScore) * 0.3));

                return {
                    predicted_category: predictedCategory,
                    confidence: confidence,
                    word_influences: wordInfluences
                };
            }

            function displayXAIResults(explanation) {
                // Update prediction metrics
                document.getElementById('xaiPrediction').textContent = explanation.predicted_category;
                document.getElementById('xaiConfidence').textContent = (explanation.confidence * 100).toFixed(1) + '%';

                // Create word influence visualization
                const wordInfluenceDiv = document.getElementById('xaiWordInfluence');
                const influences = Object.entries(explanation.word_influences);
                
                if (influences.length > 0) {
                    influences.sort((a, b) => Math.abs(b[1]) - Math.abs(a[1])); // Sort by absolute influence
                    
                    const maxInfluence = Math.max(...influences.map(([_, inf]) => Math.abs(inf)));
                    
                    wordInfluenceDiv.innerHTML = influences.map(([word, influence]) => {
                        const width = Math.abs(influence) / maxInfluence * 100;
                        const color = influence > 0 ? '#4ECDC4' : '#FF6B6B';
                        const sign = influence > 0 ? '+' : '';
                        
                        return `
                            <div style="margin: 0.5rem 0; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.25rem;">
                                    <strong style="color: ${color};">${word}</strong>
                                    <span style="color: ${color}; font-weight: bold;">${sign}${influence.toFixed(3)}</span>
                                </div>
                                <div style="background: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: ${color}; height: 100%; width: ${width}%; transition: width 0.5s ease;"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    wordInfluenceDiv.innerHTML = '<p style="text-align: center; color: #666;">No significant word influences detected</p>';
                }

                // Update positive and negative drivers
                const positiveWords = Object.entries(explanation.word_influences)
                    .filter(([_, inf]) => inf > 0)
                    .map(([word, _]) => word);
                
                const negativeWords = Object.entries(explanation.word_influences)
                    .filter(([_, inf]) => inf < 0)
                    .map(([word, _]) => word);

                document.getElementById('xaiPositiveWords').textContent = 
                    positiveWords.length > 0 ? positiveWords.join(', ') : 'None detected';
                
                document.getElementById('xaiNegativeWords').textContent = 
                    negativeWords.length > 0 ? negativeWords.join(', ') : 'None detected';

                // Show results
                document.getElementById('xaiResults').style.display = 'block';
            }

            // Export data
            function exportData() {
                if (analysisHistory.length === 0) {
                    showNotification("No data to export", "warning");
                    return;
                }

                const csvContent = [
                    [
                        "Timestamp",
                        "Comment",
                        "Category",
                        "BERT Sentiment",
                        "BERT Confidence",
                        "VADER Sentiment",
                        "VADER Compound",
                        "Aspects",
                        "Priority",
                    ].join(","),
                    ...analysisHistory.map((item) =>
                        [
                            new Date(item.timestamp).toISOString(),
                            `"${item.input_text.replace(/"/g, '""')}"`,
                            item.predicted_category,
                            item.sentiment_analysis.bert.sentiment,
                            item.sentiment_analysis.bert.confidence,
                            item.sentiment_analysis.vader.sentiment,
                            item.sentiment_analysis.vader.scores.compound,
                            `"${item.identified_aspects.join(", ")}"`,
                            item.strategic_recommendation.priority,
                        ].join(","),
                    ),
                ].join("\n");

                const blob = new Blob([csvContent], { type: "text/csv" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `tata-analysis-${Date.now()}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showNotification("Data exported successfully!", "success");
            }

            // Competitive Intelligence Functions
            function openStreamlitCompetitive() {
                const streamlitUrl = 'http://localhost:8501';
                window.open(streamlitUrl, '_blank');
                showNotification('Opening Advanced Competitive Analysis...', 'info');
            }

            function analyzeCompetitive() {
                document.getElementById('competitiveLoading').style.display = 'block';
                document.getElementById('competitiveResults').style.display = 'none';
                document.getElementById('competitiveBtn').disabled = true;

                // Simulate competitive analysis
                setTimeout(() => {
                    try {
                        const analysis = simulateCompetitiveAnalysis();
                        displayCompetitiveResults(analysis);
                        
                        showNotification("Competitive analysis complete", "success");
                    } catch (error) {
                        console.error('Competitive Analysis Error:', error);
                        showNotification("Error analyzing competitive data. Please try again.", "error");
                    } finally {
                        document.getElementById('competitiveLoading').style.display = 'none';
                        document.getElementById('competitiveBtn').disabled = false;
                    }
                }, 2500);
            }

            function simulateCompetitiveAnalysis() {
                // Simulate competitive data analysis
                const tataMentions = Math.floor(Math.random() * 500) + 200;
                const competitorMentions = Math.floor(Math.random() * 400) + 150;
                const tataPositive = Math.random() * 0.3 + 0.5; // 50-80% positive
                const competitorPositive = Math.random() * 0.4 + 0.4; // 40-80% positive
                
                const sentimentAdvantage = (tataPositive - competitorPositive) * 100;
                const shareOfVoice = (tataMentions / (tataMentions + competitorMentions)) * 100;
                
                return {
                    tataMentions,
                    competitorMentions,
                    tataPositive,
                    competitorPositive,
                    sentimentAdvantage,
                    shareOfVoice,
                    threats: generateCompetitiveThreats(),
                    recommendations: generateCompetitiveRecommendations(sentimentAdvantage, shareOfVoice)
                };
            }

            function generateCompetitiveThreats() {
                const threats = [
                    "Mahindra XUV700 gaining traction in premium SUV segment",
                    "Hyundai Creta maintaining strong market position",
                    "Maruti Suzuki's fuel efficiency advantage in compact cars",
                    "Competitor pricing strategies affecting market share"
                ];
                
                return threats.slice(0, Math.floor(Math.random() * 3) + 2);
            }

            function generateCompetitiveRecommendations(sentimentAdvantage, shareOfVoice) {
                const recommendations = [];
                
                if (sentimentAdvantage > 5) {
                    recommendations.push("✅ Leverage positive sentiment in marketing campaigns");
                    recommendations.push("📢 Amplify customer success stories and testimonials");
                } else if (sentimentAdvantage < -5) {
                    recommendations.push("⚠️ Address customer pain points highlighted by competitors");
                    recommendations.push("🔧 Implement service quality improvement initiatives");
                } else {
                    recommendations.push("⚡ Maintain competitive parity while seeking differentiation");
                }
                
                if (shareOfVoice > 55) {
                    recommendations.push("🎯 Maintain market leadership position");
                } else {
                    recommendations.push("📈 Increase brand visibility and marketing presence");
                }
                
                recommendations.push("🔍 Monitor competitor product launches and responses");
                recommendations.push("💡 Identify unmet customer needs for innovation opportunities");
                
                return recommendations;
            }

            function displayCompetitiveResults(analysis) {
                // Update KPI metrics
                document.getElementById('tataMentions').textContent = analysis.tataMentions.toLocaleString();
                document.getElementById('competitorMentions').textContent = analysis.competitorMentions.toLocaleString();
                document.getElementById('sentimentLead').textContent = 
                    (analysis.sentimentAdvantage >= 0 ? '+' : '') + analysis.sentimentAdvantage.toFixed(1) + '%';
                document.getElementById('shareOfVoice').textContent = analysis.shareOfVoice.toFixed(1) + '%';

                // Update market performance
                const performanceDiv = document.getElementById('marketPerformance');
                let performanceStatus, performanceColor;
                
                if (analysis.sentimentAdvantage > 5) {
                    performanceStatus = "Leading";
                    performanceColor = "#4CAF50";
                } else if (analysis.sentimentAdvantage < -5) {
                    performanceStatus = "Lagging";
                    performanceColor = "#F44336";
                } else {
                    performanceStatus = "Competitive";
                    performanceColor = "#FF9800";
                }
                
                performanceDiv.innerHTML = `
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 2rem; color: ${performanceColor}; margin-bottom: 0.5rem;">
                            ${performanceStatus}
                        </div>
                        <div style="font-size: 0.9rem; color: #666;">
                            ${analysis.tataPositive > analysis.competitorPositive ? 
                                'Higher positive sentiment than competitors' : 
                                'Opportunity to improve sentiment vs competitors'}
                        </div>
                        <div style="margin-top: 1rem; display: flex; justify-content: space-between;">
                            <div>
                                <strong>Tata:</strong> ${(analysis.tataPositive * 100).toFixed(1)}%
                            </div>
                            <div>
                                <strong>Competitors:</strong> ${(analysis.competitorPositive * 100).toFixed(1)}%
                            </div>
                        </div>
                    </div>
                `;

                // Update competitive threats
                const threatsDiv = document.getElementById('competitiveThreats');
                threatsDiv.innerHTML = analysis.threats.map(threat => 
                    `<div style="margin: 0.5rem 0; padding: 0.5rem; background: #fff3cd; border-left: 3px solid #856404; border-radius: 3px;">
                        <small>${threat}</small>
                    </div>`
                ).join('');

                // Create simple brand comparison chart
                const brandComparisonDiv = document.getElementById('brandComparison');
                const tataWidth = (analysis.tataPositive * 100);
                const competitorWidth = (analysis.competitorPositive * 100);
                
                brandComparisonDiv.innerHTML = `
                    <div style="padding: 1rem;">
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span><strong>Tata Motors</strong></span>
                                <span>${tataWidth.toFixed(1)}% Positive</span>
                            </div>
                            <div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: #005691; height: 100%; width: ${tataWidth}%; transition: width 0.5s ease;"></div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span><strong>Competitors</strong></span>
                                <span>${competitorWidth.toFixed(1)}% Positive</span>
                            </div>
                            <div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: #FF5733; height: 100%; width: ${competitorWidth}%; transition: width 0.5s ease;"></div>
                            </div>
                        </div>
                    </div>
                `;

                // Update strategic recommendations
                const recommendationsDiv = document.getElementById('strategicRecommendations');
                recommendationsDiv.innerHTML = `
                    <ul>
                        ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                `;

                // Show results
                document.getElementById('competitiveResults').style.display = 'block';
            }

            function refreshCompetitiveData() {
                showNotification('Refreshing competitive data...', 'info');
                // In a real implementation, this would fetch fresh data
                setTimeout(() => {
                    analyzeCompetitive();
                }, 500);
            }

            // Notification system
            function showNotification(message, type = "info") {
                const container = document.getElementById(
                    "notification-container",
                );
                const notification = document.createElement("div");
                notification.className = `notification ${type}`;

                const icons = {
                    success: "fa-check-circle",
                    error: "fa-exclamation-circle",
                    warning: "fa-exclamation-triangle",
                    info: "fa-info-circle",
                };

                notification.innerHTML = `
                <i class="fas ${icons[type] || icons.info}"></i>
                <span>${message}</span>
            `;

                container.appendChild(notification);

                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.opacity = "0";
                        notification.style.transform = "translateX(100%)";
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(
                                    notification,
                                );
                            }
                        }, 300);
                    }
                }, 5000);

                notification.onclick = () => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                };
            }

            // Save current analysis
            function saveCurrentAnalysis() {
                if (!currentAnalysis) return;

                const analysisWithTimestamp = {
                    ...currentAnalysis,
                    timestamp: Date.now(),
                    id:
                        Date.now().toString(36) +
                        Math.random().toString(36).substr(2),
                };

                analysisHistory.unshift(analysisWithTimestamp);
                if (analysisHistory.length > 100) {
                    analysisHistory = analysisHistory.slice(0, 100);
                }

                localStorage.setItem(
                    "tata_analysis_history",
                    JSON.stringify(analysisHistory),
                );
                document.getElementById("saveAnalysis").style.display = "none";
                showNotification("Analysis saved to history!", "success");
            }

            // Clear history
            function clearHistory() {
                if (
                    confirm(
                        "Are you sure you want to clear all analysis history?",
                    )
                ) {
                    analysisHistory = [];
                    localStorage.removeItem("tata_analysis_history");
                    renderHistory();
                    renderAnalytics();
                    showNotification("History cleared!", "success");
                }
            }

            // Render history
            function renderHistory() {
                const container = document.getElementById("historyContent");

                if (analysisHistory.length === 0) {
                    container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <h3>No Analysis History</h3>
                        <p>Your analyzed comments will appear here</p>
                    </div>
                `;
                    return;
                }

                container.innerHTML = `
                <div class="history-section">
                    ${analysisHistory
                        .map(
                            (item) => `
                        <div class="history-item">
                            <div class="history-header">
                                <div>
                                    <span class="category-badge category-${getCategoryClass(item.predicted_category)}">
                                        ${item.predicted_category}
                                    </span>
                                    <span class="priority-badge priority-${item.strategic_recommendation.priority.toLowerCase()}">
                                        ${item.strategic_recommendation.priority}
                                    </span>
                                    ${item.location_analysis && item.location_analysis.has_location ? 
                                        item.location_analysis.cities.map(city => `<span class="location-tag">${city}</span>`).join('') : ''}
                                </div>
                                <span class="history-timestamp">
                                    ${new Date(item.timestamp).toLocaleString()}
                                </span>
                            </div>
                            <div class="history-comment">${item.input_text}</div>
                            <div class="sentiment-badges">
                                <div class="sentiment-badge sentiment-${item.sentiment_analysis.bert.sentiment}">
                                    BERT: ${item.sentiment_analysis.bert.sentiment} (${(item.sentiment_analysis.bert.confidence * 100).toFixed(1)}%)
                                </div>
                                <div class="sentiment-badge sentiment-${item.sentiment_analysis.vader.sentiment}">
                                    VADER: ${item.sentiment_analysis.vader.sentiment} (${item.sentiment_analysis.vader.scores.compound.toFixed(3)})
                                </div>
                            </div>
                            <div class="aspects-container">
                                ${item.identified_aspects.map((aspect) => `<span class="aspect-tag">${aspect}</span>`).join("")}
                            </div>
                        </div>
                    `,
                        )
                        .join("")}
                </div>
            `;
            }

            // Render analytics
            function renderAnalytics() {
                if (analysisHistory.length === 0) {
                    document.getElementById("totalAnalyses").textContent = "0";
                    document.getElementById("avgConfidence").textContent = "0%";
                    document.getElementById("topCategory").textContent = "-";
                    document.getElementById("topAspect").textContent = "-";
                    return;
                }

                // Calculate statistics
                const totalAnalyses = analysisHistory.length;
                const avgConfidence =
                    analysisHistory.reduce(
                        (sum, item) =>
                            sum + item.sentiment_analysis.bert.confidence,
                        0,
                    ) / totalAnalyses;

                // Category counts
                const categoryCounts = {};
                const aspectCounts = {};
                const sentimentCounts = {
                    positive: 0,
                    negative: 0,
                    neutral: 0,
                };

                analysisHistory.forEach((item) => {
                    categoryCounts[item.predicted_category] =
                        (categoryCounts[item.predicted_category] || 0) + 1;
                    sentimentCounts[item.sentiment_analysis.bert.sentiment]++;
                    item.identified_aspects.forEach((aspect) => {
                        aspectCounts[aspect] = (aspectCounts[aspect] || 0) + 1;
                    });
                });

                const topCategory =
                    Object.entries(categoryCounts).sort(
                        ([, a], [, b]) => b - a,
                    )[0]?.[0] || "-";
                const topAspect =
                    Object.entries(aspectCounts).sort(
                        ([, a], [, b]) => b - a,
                    )[0]?.[0] || "-";

                // Update display
                document.getElementById("totalAnalyses").textContent =
                    totalAnalyses;
                document.getElementById("avgConfidence").textContent =
                    `${(avgConfidence * 100).toFixed(1)}%`;
                document.getElementById("topCategory").textContent =
                    topCategory.split(" / ")[0];
                document.getElementById("topAspect").textContent = topAspect;

                // Render sentiment chart
                const sentimentChart =
                    document.getElementById("sentimentChart");
                const total = Object.values(sentimentCounts).reduce(
                    (a, b) => a + b,
                    0,
                );

                sentimentChart.innerHTML = `
                <div style="padding: 1rem;">
                    ${Object.entries(sentimentCounts)
                        .map(([sentiment, count]) => {
                            const percentage =
                                total > 0
                                    ? ((count / total) * 100).toFixed(1)
                                    : 0;
                            return `
                            <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                                <div style="flex: 0 0 80px; text-transform: capitalize; font-weight: 500;">${sentiment}:</div>
                                <div style="flex: 1; background: var(--border-color); height: 20px; border-radius: 10px; overflow: hidden; margin: 0 1rem;">
                                    <div class="sentiment-${sentiment}" style="height: 100%; width: ${percentage}%; transition: width 0.5s ease;"></div>
                                </div>
                                <div style="flex: 0 0 60px; text-align: right; font-weight: 600;">${percentage}%</div>
                            </div>
                        `;
                        })
                        .join("")}
                </div>
            `;

                // Render category chart
                const categoryChart = document.getElementById("categoryChart");
                const categoryTotal = Object.values(categoryCounts).reduce(
                    (a, b) => a + b,
                    0,
                );

                categoryChart.innerHTML = `
                <div style="padding: 1rem;">
                    ${Object.entries(categoryCounts)
                        .map(([category, count]) => {
                            const percentage =
                                categoryTotal > 0
                                    ? ((count / categoryTotal) * 100).toFixed(1)
                                    : 0;
                            const shortCategory = category.split(" / ")[0];
                            return `
                            <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                                <div style="flex: 0 0 120px; font-weight: 500;">${shortCategory}:</div>
                                <div style="flex: 1; background: var(--border-color); height: 20px; border-radius: 10px; overflow: hidden; margin: 0 1rem;">
                                    <div style="height: 100%; width: ${percentage}%; background: var(--tata-blue); transition: width 0.5s ease;"></div>
                                </div>
                                <div style="flex: 0 0 60px; text-align: right; font-weight: 600;">${count}</div>
                            </div>
                        `;
                        })
                        .join("")}
                </div>
            `;
            }

            // Get category class for styling with enhanced ML categories
            function getCategoryClass(category) {
                if (
                    category.includes("Complaint") ||
                    category.includes("Criticism")
                )
                    return "complaint";
                if (
                    category.includes("Praise") ||
                    category.includes("Satisfaction")
                )
                    return "praise";
                if (
                    category.includes("Suggestion") ||
                    category.includes("Feature Request")
                )
                    return "suggestion";
                if (
                    category.includes("Inquiry") ||
                    category.includes("Purchase") ||
                    category.includes("Question")
                )
                    return "inquiry";
                if (
                    category.includes("Comparison") ||
                    category.includes("Competitive")
                )
                    return "comparison";
                return "complaint";
            }

            // Update sentiment display
            function updateSentimentDisplay(bertResult, vaderResult) {
                const bertSentimentDiv =
                    document.getElementById("bertSentiment");
                const bertSentimentText =
                    document.getElementById("bertSentimentText");
                const bertConfidence =
                    document.getElementById("bertConfidence");
                const bertConfidenceText =
                    document.getElementById("bertConfidenceText");

                bertSentimentText.textContent =
                    bertResult.sentiment.toUpperCase();
                bertConfidence.style.width = bertResult.confidence * 100 + "%";
                bertConfidenceText.textContent =
                    (bertResult.confidence * 100).toFixed(1) + "%";
                bertSentimentDiv.className =
                    "sentiment-badge sentiment-" + bertResult.sentiment;

                const vaderSentimentDiv =
                    document.getElementById("vaderSentiment");
                const vaderSentimentText =
                    document.getElementById("vaderSentimentText");
                const vaderScores = document.getElementById("vaderScores");

                vaderSentimentText.textContent =
                    vaderResult.sentiment.toUpperCase();
                vaderSentimentDiv.className =
                    "sentiment-badge sentiment-" + vaderResult.sentiment;

                if (vaderResult.scores) {
                    vaderScores.innerHTML = `
                    <small style="font-size: 0.75rem; opacity: 0.8; line-height: 1.2;">
                        Pos: ${vaderResult.scores.positive} | Neu: ${vaderResult.scores.neutral} | Neg: ${vaderResult.scores.negative}<br>
                        Compound: ${vaderResult.scores.compound}
                    </small>
                `;
                }
            }

            // Update category display with enhanced ML categories
            function updateCategoryDisplay(category) {
                const categoryResult =
                    document.getElementById("categoryResult");
                const categoryClass = getCategoryClass(category);
                // Add ML-powered indicator
                const mlIndicator =
                    '<i class="fas fa-robot" style="margin-left: 0.5rem; color: #10b981;" title="ML-Powered Classification"></i>';
                categoryResult.innerHTML = `<span class="category-badge category-${categoryClass}">${category}${mlIndicator}</span>`;
            }

            // Update aspects display
            function updateAspectsDisplay(aspects) {
                const aspectsResult = document.getElementById("aspectsResult");
                if (aspects.length === 0) {
                    aspectsResult.innerHTML =
                        '<span style="color: var(--text-secondary); font-style: italic;">No specific aspects detected</span>';
                    return;
                }
                aspectsResult.innerHTML = aspects
                    .map(
                        (aspect) => `<span class="aspect-tag">${aspect}</span>`,
                    )
                    .join("");
            }

            // Update recommendation display
            function updateRecommendationDisplay(recommendation) {
                document.getElementById("insightText").textContent =
                    recommendation.insight;
                document.getElementById("strategyText").textContent =
                    recommendation.strategy;
                document.getElementById("actionText").textContent =
                    recommendation.action;

                // Handle both old and new recommendation formats
                const consensusText =
                    recommendation.sentiment_consensus ||
                    `ML-Powered Analysis: ${recommendation.priority} Priority Action Required`;
                document.getElementById("consensusText").textContent =
                    consensusText;

                const priorityBadge = document.getElementById("priorityBadge");
                priorityBadge.textContent = recommendation.priority;
                priorityBadge.className = `priority-badge priority-${recommendation.priority.toLowerCase()}`;

                document.getElementById("recommendationCard").style.display =
                    "block";
            }

            // Generate sales strategies
            function generateSalesStrategies(analysisData) {
                const strategies = [];
                const {
                    predicted_category,
                    identified_aspects,
                    sentiment_analysis,
                } = analysisData;

                // Category-based strategies
                if (predicted_category.includes("Complaint")) {
                    strategies.push({
                        title: "Immediate Customer Recovery",
                        description:
                            "Reach out to dissatisfied customers within 24 hours to address concerns and demonstrate commitment to improvement.",
                        impact: "High",
                        timeline: "Immediate",
                    });
                }

                if (predicted_category.includes("Praise")) {
                    strategies.push({
                        title: "Leverage Positive Testimonials",
                        description:
                            "Use satisfied customer feedback in marketing campaigns and social media to build brand credibility.",
                        impact: "Medium",
                        timeline: "1-2 weeks",
                    });
                }

                if (predicted_category.includes("Suggestion")) {
                    strategies.push({
                        title: "Customer Co-Creation Initiative",
                        description:
                            "Establish feedback channels to involve customers in product development and feature prioritization.",
                        impact: "Medium",
                        timeline: "1-3 months",
                    });
                }

                if (
                    predicted_category.includes("Purchase") ||
                    predicted_category.includes("Inquiry")
                ) {
                    strategies.push({
                        title: "Sales Acceleration Program",
                        description:
                            "Ensure immediate follow-up with potential customers to provide detailed information and schedule test drives.",
                        impact: "High",
                        timeline: "Immediate",
                    });
                }

                // Aspect-specific strategies
                if (identified_aspects.includes("EV")) {
                    strategies.push({
                        title: "EV Education Campaign",
                        description:
                            "Conduct workshops and demonstrations to address range anxiety and showcase EV benefits and charging infrastructure.",
                        impact: "High",
                        timeline: "2-4 weeks",
                    });
                }

                if (identified_aspects.includes("Service")) {
                    strategies.push({
                        title: "Service Excellence Initiative",
                        description:
                            "Implement service quality monitoring and enhanced training programs for dealership staff.",
                        impact: "High",
                        timeline: "4-8 weeks",
                    });
                }

                if (identified_aspects.includes("Features")) {
                    strategies.push({
                        title: "Feature Showcase Program",
                        description:
                            "Create interactive demonstrations and digital content highlighting unique features and technology advantages.",
                        impact: "Medium",
                        timeline: "2-6 weeks",
                    });
                }

                // Sentiment-based strategies
                const bertSentiment = sentiment_analysis.bert.sentiment;
                if (bertSentiment === "negative") {
                    strategies.push({
                        title: "Reputation Management Protocol",
                        description:
                            "Monitor and respond to negative feedback across all platforms with empathy and actionable solutions.",
                        impact: "High",
                        timeline: "Ongoing",
                    });
                }

                if (bertSentiment === "positive") {
                    strategies.push({
                        title: "Momentum Building Strategy",
                        description:
                            "Amplify positive sentiment through strategic content marketing and community building initiatives.",
                        impact: "Medium",
                        timeline: "2-4 weeks",
                    });
                }

                // Display strategies
                const strategiesList =
                    document.getElementById("strategiesList");
                strategiesList.innerHTML = strategies
                    .map(
                        (strategy) => `
                <li class="strategy-item">
                    <div class="strategy-title">${strategy.title}</div>
                    <div class="strategy-description">${strategy.description}</div>
                    <div class="strategy-meta">
                        <span class="impact-badge impact-${strategy.impact.toLowerCase()}">${strategy.impact} Impact</span>
                        <span class="timeline-badge">${strategy.timeline}</span>
                    </div>
                </li>
            `,
                    )
                    .join("");

                document.getElementById("salesStrategies").style.display =
                    "block";
            }

            // Main analysis function
            async function analyzeComment() {
                const text = document
                    .getElementById("commentText")
                    .value.trim();

                if (!text) {
                    showNotification(
                        "Please enter a customer comment to analyze.",
                        "warning",
                    );
                    return;
                }

                const analyzeBtn = document.getElementById("analyzeBtn");
                const loading = document.getElementById("loading");
                const results = document.getElementById("results");

                analyzeBtn.disabled = true;
                loading.style.display = "block";
                results.style.display = "none";
                document.getElementById("recommendationCard").style.display =
                    "none";
                document.getElementById("salesStrategies").style.display =
                    "none";
                document.getElementById("saveAnalysis").style.display = "none";

                const startTime = Date.now();

                try {
                    const response = await fetch(`${API_BASE_URL}/analyze`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ text: text }),
                    });

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    const responseTime = Date.now() - startTime;

                    // Store current analysis
                    currentAnalysis = data;

                    // Update displays
                    updateCategoryDisplay(data.predicted_category);
                    updateSentimentDisplay(
                        data.sentiment_analysis.bert,
                        data.sentiment_analysis.vader,
                    );
                    updateAspectsDisplay(data.identified_aspects);
                    updateLocationDisplay(data.location_analysis); // New location display
                    updateRecommendationDisplay(data.strategic_recommendation);
                    generateSalesStrategies(data);

                    // Show results
                    results.style.display = "block";
                    document.getElementById("saveAnalysis").style.display =
                        "inline-flex";

                    showNotification(
                        `Analysis completed in ${responseTime}ms!`,
                        "success",
                    );

                    // Scroll to results
                    results.scrollIntoView({
                        behavior: "smooth",
                        block: "start",
                    });
                } catch (error) {
                    console.error("Analysis error:", error);
                    showNotification(
                        `Analysis failed: ${error.message}. Please ensure the backend server is running.`,
                        "error",
                    );
                } finally {
                    loading.style.display = "none";
                    analyzeBtn.disabled = false;
                }
            }

            // Initialize page
            document.addEventListener("DOMContentLoaded", function () {
                // Check API health
                fetch(`${API_BASE_URL}/health`)
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.status === "healthy") {
                            showNotification(
                                "Connected to Tata Motors Analysis API",
                                "success",
                            );
                        }
                    })
                    .catch((error) => {
                        showNotification(
                            "Backend API not accessible. Please start the Flask server.",
                            "error",
                        );
                    });

                // Load saved theme
                const savedTheme = localStorage.getItem("tata_theme");
                if (savedTheme === "dark") {
                    toggleTheme();
                }

                // Initialize analytics if history exists
                if (analysisHistory.length > 0) {
                    renderAnalytics();
                }

                // Keyboard shortcuts
                document
                    .getElementById("commentText")
                    .addEventListener("keydown", function (e) {
                        if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
                            analyzeComment();
                        }
                    });
            });
        </script>
    </body>
</html>
